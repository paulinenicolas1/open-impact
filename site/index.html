<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Climate France</title>
    <style>
        :root {
            color-scheme: dark;
            --bg: #0f1116;
            --panel: #1a1f28;
            --panel-soft: #202630;
            --text: #f5f6f8;
            --muted: #a7b0bf;
            --accent: #34b4ff;
            --accent-strong: #0f7fbf;
            --border: #2a323f;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "Inter", "Segoe UI", system-ui, sans-serif;
            background: radial-gradient(circle at top, #1a202c 0%, #0f1116 40%, #0c0f14 100%);
            color: var(--text);
        }

        .page {
            max-width: 1160px;
            margin: 0 auto;
            padding: 28px 24px 48px;
        }

        header {
            display: flex;
            align-items: center;
            gap: 18px;
            justify-content: space-between;
            background: #12161f;
            border: 1px solid var(--border);
            padding: 14px 18px;
            border-radius: 16px;
            box-shadow: 0 18px 30px rgba(0, 0, 0, 0.25);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            letter-spacing: 0.2px;
        }

        .brand-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: linear-gradient(135deg, #4cc9f0, #4895ef);
            display: grid;
            place-items: center;
            font-size: 18px;
            color: #09141f;
        }

        nav {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .city-btn {
            border: 1px solid transparent;
            padding: 8px 16px;
            border-radius: 999px;
            background: transparent;
            color: var(--muted);
            font-size: 14px;
            cursor: pointer;
        }

        .city-btn:hover {
            color: var(--text);
        }

        .city-btn.active {
            background: #1f2734;
            color: var(--text);
            border-color: #2c3747;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .search {
            display: flex;
            align-items: center;
            background: #161b24;
            border: 1px solid var(--border);
            border-radius: 999px;
            padding: 8px 14px;
            gap: 8px;
            color: var(--muted);
            font-size: 14px;
            min-width: 240px;
        }

        .search input {
            background: transparent;
            border: none;
            color: var(--text);
            outline: none;
            font-size: 14px;
            width: 100%;
        }

        .export-btn {
            border: none;
            padding: 10px 16px;
            border-radius: 10px;
            color: white;
            background: linear-gradient(135deg, var(--accent), var(--accent-strong));
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .title-block {
            margin: 34px 0 24px;
        }

        .title-row {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        h1 {
            margin: 0;
            font-size: 40px;
            letter-spacing: -0.5px;
        }

        .badge {
            background: #112431;
            color: #5fd0ff;
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .subtitle {
            margin-top: 12px;
            max-width: 720px;
            color: var(--muted);
            line-height: 1.6;
        }

        .metrics {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }

        .metric-card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 18px;
            position: relative;
            overflow: hidden;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
        }

        .metric-card:hover {
            border-color: rgba(95, 208, 255, 0.7);
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.35);
            transform: translateY(-2px);
        }

        .metric-card::after {
            content: "";
            position: absolute;
            height: 2px;
            width: 100%;
            bottom: 0;
            left: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.35), transparent);
        }

        .metric-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--muted);
            margin-bottom: 10px;
        }

        .metric-value {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .metric-change {
            font-size: 12px;
            color: #5eead4;
        }

        .metric-card.orange .metric-change {
            color: #fbbf24;
        }

        .metric-card.blue .metric-change {
            color: #38bdf8;
        }

        @media (max-width: 900px) {
            header {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-actions {
                width: 100%;
                flex-direction: column;
                align-items: stretch;
            }

            .search {
                min-width: 0;
            }
        }
    </style>
</head>
<body>
<div class="page">
    <header>
        <div class="brand">
            <div class="brand-icon">üå§Ô∏è</div>
            <div>Climate France</div>
        </div>
        <nav>
            <button class="city-btn active" data-city="Paris" aria-pressed="true">Paris</button>
            <button class="city-btn" data-city="Lyon" aria-pressed="false">Lyon</button>
            <button class="city-btn" data-city="Marseille" aria-pressed="false">Marseille</button>
            <button class="city-btn" data-city="Bordeaux" aria-pressed="false">Bordeaux</button>
        </nav>
        <div class="header-actions">
            <label class="search">
                üîç
                <input type="search" placeholder="Rechercher une ville..." />
            </label>
            <button class="export-btn">‚¨áÔ∏è Exporter</button>
        </div>
    </header>

    <section class="title-block">
        <div class="title-row">
            <h1 id="city-name">Paris</h1>
            <span class="badge" id="station-id">Station ID ¬∑ 71490</span>
        </div>
        <p class="subtitle" id="city-summary">
            Analyse comparative approfondie des tendances climatiques et des pr√©cipitations observ√©es de 1900 √† 2025.
            Donn√©es bas√©es sur les relev√©s historiques de M√©t√©o-France.
        </p>
    </section>

    <section class="metrics">
        <article class="metric-card orange">
            <div class="metric-title">Temp√©rature moyenne en <span data-year-label></span></div>
            <div class="metric-value" data-metric="avgTemp">Donn√©e indisponible</div>
            <div class="metric-change" data-metric="avgTempChange">Donn√©e indisponible</div>
        </article>
        <article class="metric-card">
            <div class="metric-title">Temp√©rature max en <span data-year-label></span></div>
            <div class="metric-value" data-metric="maxTemp">Donn√©e indisponible</div>
            <div class="metric-change" data-metric="maxTempChange">Donn√©e indisponible</div>
        </article>
        <article class="metric-card blue">
            <div class="metric-title">Pr√©cipitation en <span data-year-label></span></div>
            <div class="metric-value" data-metric="rainfall">Donn√©e indisponible</div>
            <div class="metric-change" data-metric="rainfallChange">Donn√©e indisponible</div>
        </article>
    </section>
</div>
<script>
    const summaryText =
        "Analyse comparative approfondie des tendances climatiques et des pr√©cipitations observ√©es de 1900 √† 2025. Donn√©es bas√©es sur les relev√©s historiques de M√©t√©o-France.";

    const cityData = {
        Paris: {
            stationId: "Station ID ¬∑ 71490",
            summary: summaryText,
            metrics: {},
        },
        Lyon: {
            stationId: "Station ID ¬∑ 29821",
            summary: summaryText,
            metrics: {},
        },
        Marseille: {
            stationId: "Station ID ¬∑ 55807",
            summary: summaryText,
            metrics: {},
        },
        Bordeaux: {
            stationId: "Station ID ¬∑ 66342",
            summary: summaryText,
            metrics: {},
        },
    };

    const valeurTableau = {
        Paris: "paris",
        Brest: "brest",
        Lille: "lille",
        Bordeaux: "bordeaux",
        Lyon: "lyon",
        Marseille: "marseille",
    };

    const cityButtons = document.querySelectorAll(".city-btn");
    const cityName = document.getElementById("city-name");
    const stationId = document.getElementById("station-id");
    const citySummary = document.getElementById("city-summary");
    const metricNodes = document.querySelectorAll("[data-metric]");
    const yearLabels = document.querySelectorAll("[data-year-label]");
    const lastFullYear = Number.parseInt(new Date().getFullYear() - 1, 10);
    const yearlyMetrics = new Map();

    yearLabels.forEach((label) => {
        label.textContent = lastFullYear;
    });

    const formatNumber = (value, options) => {
        if (!Number.isFinite(value)) {
            return null;
        }
        return new Intl.NumberFormat("fr-FR", options).format(value);
    };

    const formatTemperature = (value) => {
        const formatted = formatNumber(value, {
            minimumFractionDigits: 1,
            maximumFractionDigits: 1,
        });
        return formatted ? `${formatted}¬∞C` : "Donn√©e indisponible";
    };

    const formatRainfall = (value) => {
        const formatted = formatNumber(value, {
            maximumFractionDigits: 1,
        });
        return formatted ? `${formatted} mm` : "Donn√©e indisponible";
    };

    const parseCsvLine = (line, delimiter) => {
        const values = [];
        let current = "";
        let insideQuotes = false;

        for (let i = 0; i < line.length; i += 1) {
            const char = line[i];
            if (char === '"') {
                if (insideQuotes && line[i + 1] === '"') {
                    current += '"';
                    i += 1;
                } else {
                    insideQuotes = !insideQuotes;
                }
                continue;
            }
            if (char === delimiter && !insideQuotes) {
                values.push(current);
                current = "";
                continue;
            }
            current += char;
        }
        values.push(current);
        return values;
    };

    const parseCsv = (text) => {
        const trimmed = text.trim();
        if (!trimmed) {
            return [];
        }
        const lines = trimmed.split(/\r?\n/);
        const headerLine = lines[0];
        const delimiter = headerLine.includes(";") && !headerLine.includes(",") ? ";" : ",";
        const headers = parseCsvLine(headerLine, delimiter).map((header) => header.trim());
        return lines.slice(1).map((line) => {
            const values = parseCsvLine(line, delimiter);
            const row = {};
            headers.forEach((header, index) => {
                row[header] = values[index];
            });
            return row;
        });
    };

    const toNumber = (value) => {
        if (value === undefined || value === null || value === "") {
            return null;
        }
        const numeric = Number(String(value).replace(",", "."));
        return Number.isFinite(numeric) ? numeric : null;
    };

    const loadYearlyMetrics = async () => {
        try {
            const response = await fetch("data/output/final_yearly.csv");
            if (!response.ok) {
                return;
            }
            const text = await response.text();
            const rows = parseCsv(text);
            rows.forEach((row) => {
                const year = Number.parseInt(String(row.AAAA).trim(), 10);
                if (year !== lastFullYear) {
                    return;
                }
                const cityKey = String(row.ville || "").trim();
                if (!cityKey) {
                    return;
                }
                yearlyMetrics.set(cityKey, {
                    avgTemp: toNumber(row.TMM),
                    maxTemp: toNumber(row.TXAB),
                    rainfall: toNumber(row.RR),
                });
            });
        } catch (error) {
            console.warn("Impossible de charger les m√©triques annuelles.", error);
        }
    };

    const getComputedMetrics = (city) => {
        const cityKey = valeurTableau[city];
        if (!cityKey) {
            return {};
        }
        const metrics = yearlyMetrics.get(cityKey);
        if (!metrics) {
            return {};
        }
        return {
            avgTemp: formatTemperature(metrics.avgTemp),
            maxTemp: formatTemperature(metrics.maxTemp),
            rainfall: formatRainfall(metrics.rainfall),
        };
    };

    const updateDashboard = (city) => {
        const data = cityData[city];
        if (!data) {
            return;
        }
        cityName.textContent = city;
        stationId.textContent = data.stationId;
        citySummary.textContent = data.summary;
        const baseMetrics = {
            avgTemp: "Donn√©e indisponible",
            avgTempChange: "Donn√©e indisponible",
            maxTemp: "Donn√©e indisponible",
            maxTempChange: "Donn√©e indisponible",
            rainfall: "Donn√©e indisponible",
            rainfallChange: "Donn√©e indisponible",
        };
        const metrics = {
            ...baseMetrics,
            ...data.metrics,
            ...getComputedMetrics(city),
        };
        metricNodes.forEach((node) => {
            const key = node.dataset.metric;
            node.textContent = metrics[key];
        });
    };

    loadYearlyMetrics().then(() => {
        updateDashboard(cityName.textContent);
    });

    cityButtons.forEach((button) => {
        button.addEventListener("click", () => {
            cityButtons.forEach((item) => {
                item.classList.remove("active");
                item.setAttribute("aria-pressed", "false");
            });
            button.classList.add("active");
            button.setAttribute("aria-pressed", "true");
            updateDashboard(button.dataset.city);
        });
    });
</script>
</body>
</html>
